<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Analytics | Phase Intelligence</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --card-hover: #334155;
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            --accent: #38bdf8;

            --green: #4ade80;
            --red: #f87171;
            --yellow: #facc15;
            --orange: #fb923c;

            --border: #334155;

            --phase-early: #38bdf8;
            --phase-expansion: #4ade80;
            --phase-hype: #facc15;
            --phase-destructive: #f87171;
            --phase-post: #22d3ee;
            --phase-accum: #a78bfa;
            --phase-unknown: #94a3b8;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .filter-group label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            background: var(--bg);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            font-size: 14px;
        }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: 360px 1fr;
            grid-template-rows: 56px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        @media (max-width: 1000px) {
            .layout {
                grid-template-columns: 1fr;
                grid-template-rows: 56px auto 1fr;
                height: auto;
                overflow: auto;
            }
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .status-ok {
            color: var(--green);
            background: rgba(74, 222, 128, 0.15);
        }

        .status-err {
            color: var(--red);
            background: rgba(248, 113, 113, 0.15);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--card);
        }

        .sidebar-body {
            padding: 1.5rem;
            flex: 1;
        }

        .block-title {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }

        /* Phase Block */
        .phase-block {
            margin-bottom: 2rem;
        }

        .phase-display {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }

        .main-phase-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .confidence-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }

        .ev-large {
            font-family: 'Roboto Mono', monospace;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .asymmetry-text {
            font-size: 0.8rem;
            color: var(--accent);
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* Signal Block */
        .signal-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
        }

        .signal-label {
            color: var(--text-dim);
        }

        .signal-val {
            font-family: 'Roboto Mono', monospace;
            font-weight: 600;
        }

        .signal-interpretation {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-left: 0.5rem;
            font-style: italic;
        }

        /* Decision Bias */
        .decision-CONSIDER {
            color: var(--yellow);
        }

        .decision-BUY {
            color: var(--green);
        }

        .decision-WATCH {
            color: var(--accent);
        }

        .decision-AVOID {
            color: var(--red);
        }

        .decision-WAIT {
            color: var(--text-dim);
        }

        /* Main Content */
        .main {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #0f131a;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--card);
            padding: 0 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            color: var(--text-main);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-panel {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-panel.active {
            display: flex;
        }

        /* Table */
        .table-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
        }

        th {
            text-align: left;
            padding: 0.75rem 1rem;
            color: var(--text-dim);
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            position: sticky;
            top: 0;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        td {
            padding: 0.85rem 1rem;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
            vertical-align: middle;
            background: var(--card);
        }

        tr:hover td {
            background: var(--card-hover);
            cursor: pointer;
        }

        tr.selected td {
            background: rgba(56, 189, 248, 0.1);
            border-bottom-color: rgba(56, 189, 248, 0.3);
        }

        /* Badges */
        .badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .bg-early {
            background: rgba(56, 189, 248, 0.15);
            color: var(--phase-early);
        }

        .bg-xp {
            background: rgba(74, 222, 128, 0.15);
            color: var(--phase-expansion);
        }

        .bg-hype {
            background: rgba(250, 204, 21, 0.15);
            color: var(--phase-hype);
        }

        .bg-dest {
            background: rgba(248, 113, 113, 0.15);
            color: var(--phase-destructive);
        }

        .bg-post {
            background: rgba(34, 211, 238, 0.15);
            color: var(--phase-post);
        }

        .bg-accum {
            background: rgba(167, 139, 250, 0.15);
            color: var(--phase-accum);
        }

        .bg-unk {
            background: rgba(148, 163, 184, 0.1);
            color: var(--phase-unknown);
        }

        .decision-badge {
            border: 1px solid currentColor;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        .green {
            color: var(--green);
        }

        .red {
            color: var(--red);
        }

        .yellow {
            color: var(--yellow);
        }

        .dim {
            color: var(--text-dim);
        }

        .mono {
            font-family: 'Roboto Mono', monospace;
        }

        /* Discovery Filters */
        .filter-row {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .filter-group label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <div class="layout">
        <!-- Header -->
        <header>
            <div class="brand"><span style="color: var(--accent);">‚ö°</span> Phase Intelligence</div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span class="status-badge status-ok" id="connection-status">ONLINE</span>
            </div>
        </header>

        <!-- Sidebar (Decision Engine) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <input type="hidden" id="selected-mint">
                <div id="detail-name" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.2rem;">Select Token
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div id="detail-mint" class="mono dim" style="font-size: 0.75rem;">‚Äî</div>
                    <a id="detail-dex-link" href="#" target="_blank"
                        style="font-size: 0.75rem; color: var(--accent); text-decoration: none;">DexScreener ‚Üó</a>
                </div>
            </div>

            <div class="sidebar-body">
                <!-- A. Phase Status Block -->
                <div class="phase-block">
                    <div class="block-title">Phase Status</div>
                    <div class="phase-display">
                        <span id="detail-phase-badge" class="main-phase-badge bg-unk">NO DATA</span>
                        <div class="asymmetry-text" id="detail-asymmetry">‚Äî</div>
                        <div class="confidence-row">
                            <span>EV Score</span>
                            <span id="detail-ev" class="ev-large" style="color: var(--text-dim);">0.00</span>
                        </div>
                        <div class="confidence-row" style="margin-top: 0.2rem;">
                            <span>Time in Phase</span>
                            <span id="detail-time" class="mono" style="color: var(--text-dim);">0d</span>
                        </div>
                        <div class="confidence-row" style="margin-top: 0.2rem;">
                            <span>Decision Bias</span>
                            <span id="detail-bias" class="decision-badge decision-WAIT">WAIT</span>
                        </div>
                    </div>
                </div>

                <!-- B. EV Score Components -->
                <div style="margin-bottom: 2rem;">
                    <div class="block-title">Scoring Breakdown</div>
                    <div class="signal-row">
                        <span class="signal-label">Momentum (0-25)</span>
                        <span id="sig-structural" class="signal-val">‚Äî</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">Liquidity (0-20)</span>
                        <span id="sig-capital" class="signal-val">‚Äî</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">Participation (0-20)</span>
                        <span id="sig-lifecycle" class="signal-val">‚Äî</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">Wallet Conviction (0-20)</span>
                        <span id="sig-wallet" class="signal-val">‚Äî</span>
                    </div>
                </div>

                <!-- C. Participation Metrics -->
                <div style="margin-bottom: 2rem;">
                    <div class="block-title">Participation</div>
                    <div class="signal-row">
                        <span class="signal-label">Uniques (48h)</span>
                        <span id="sig-uniques" class="signal-val">‚Äî</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">USR</span>
                        <div style="text-align: right;">
                            <span id="sig-ratio" class="signal-val">‚Äî</span>
                            <span id="int-ratio" class="signal-interpretation"></span>
                        </div>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">VPU</span>
                        <div style="text-align: right;">
                            <span id="sig-vpu" class="signal-val">‚Äî</span>
                        </div>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">VPU Stability (CV)</span>
                        <span id="sig-cv" class="signal-val">‚Äî</span>
                    </div>
                </div>

                <!-- D. Growth & Risk -->
                <div style="margin-bottom: 2rem;">
                    <div class="block-title">Growth & Risk</div>
                    <div class="signal-row">
                        <span class="signal-label">Unique Growth (2d)</span>
                        <span id="sig-ugr" class="signal-val">‚Äî</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">Volume Growth (2d)</span>
                        <span id="sig-vgr" class="signal-val">‚Äî</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">Decline from Peak</span>
                        <span id="sig-decline" class="signal-val red">‚Äî</span>
                    </div>
                    <div class="signal-row">
                        <span class="signal-label">Days Since Peak</span>
                        <span id="sig-dsp" class="signal-val">‚Äî</span>
                    </div>
                </div>

                <!-- Alert Form (Mini) -->
                <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                    <div class="block-title">Set Alert</div>
                    <form onsubmit="createAlert(event)" style="display: flex; gap: 0.5rem;">
                        <select id="alert-metric"
                            style="flex:1; background:var(--bg); color:white; border:1px solid var(--border); padding:0.3rem;">
                            <option value="swap_count_1h">Swaps > Limit</option>
                        </select>
                        <input id="alert-val" placeholder="Value"
                            style="width: 60px; background:var(--bg); color:white; border:1px solid var(--border); padding:0.3rem;">
                        <button
                            style="background:var(--accent); border:none; border-radius:3px; font-weight:700;">+</button>
                    </form>
                    <div id="alert-msg" style="font-size:0.7rem; margin-top:0.3rem;"></div>
                </div>

                <!-- Active Alerts List -->
                <div style="margin-top: 1.5rem;">
                    <div class="block-title">Active Alerts</div>
                    <div id="alerts-list" style="font-size: 0.8rem; color: var(--text-dim);">Loading...</div>
                </div>

                <!-- Phase Transition Check -->
                <div style="margin-top: 1.5rem;">
                    <button onclick="checkPhaseTransitions()"
                        style="width:100%; background: rgba(250,204,21,0.15); color: var(--yellow); border: 1px solid var(--yellow); padding: 0.5rem; border-radius: 4px; font-weight: 600; cursor: pointer;">
                        üîî Check Phase Transitions
                    </button>
                    <div id="phase-check-msg" style="font-size:0.7rem; margin-top:0.3rem;"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <div class="tabs">
                <div class="tab active" data-tab="phase-tab" onclick="switchTab('phase-tab')">Ranked Tokens</div>
                <div class="tab" data-tab="sniper-tab" onclick="switchTab('sniper-tab')">üéØ Sniper Mode</div>
                <div class="tab" data-tab="completed-tab" onclick="switchTab('completed-tab')">Completed</div>
                <div class="tab" data-tab="discovery-tab" onclick="switchTab('discovery-tab')">üîç Discovery</div>
                <div class="tab" data-tab="ops-tab" onclick="switchTab('ops-tab')">Operations</div>
            </div>

            <!-- TAB 1: Ranked Tokens -->
            <div id="phase-tab" class="tab-panel active">
                <!-- Filter/Sort Controls -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Min Score</label>
                        <input id="f-min-score" type="number" placeholder="0" style="width:55px;"
                            oninput="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Lifecycle</label>
                        <select id="f-lifecycle" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="PRE_ELIGIBLE">Pre-Eligible</option>
                            <option value="ACTIVE_MONITORING">Active</option>
                            <option value="ELIGIBLE_PENDING_30M">Pending</option>
                            <option value="SUCCESS">Success</option>
                            <option value="FAILED">Failed</option>
                            <option value="EXPIRED">Expired</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="f-status" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="active">Active Only</option>
                            <option value="completed">Completed Only</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Sort</label>
                        <select id="f-sort" onchange="applyFilters()">
                            <option value="ev_score">Score ‚Üì</option>
                            <option value="volume_acceleration">Vol Accel ‚Üì</option>
                            <option value="current_price">Price ‚Üì</option>
                            <option value="multiplier">Multiplier ‚Üì</option>
                            <option value="snapshot_time">Snapshot Time ‚Üì</option>
                            <option value="risk_penalty">Risk ‚Üì</option>
                            <option value="wallet_score">Wallet ‚Üì</option>
                        </select>
                    </div>
                    <div style="flex:1;"></div>
                    <div style="font-size:0.75rem; color:var(--text-dim); align-self:flex-end;" id="filter-count"></div>
                </div>
                <div class="table-wrapper" style="overflow-x:auto;">
                    <table id="rankings-table" style="min-width:1400px;">
                        <thead>
                            <tr>
                                <th>Token</th>
                                <th>Price</th>
                                <th>Mult</th>
                                <th>Score</th>
                                <th>Risk</th>
                                <th>Wallet</th>
                                <th>Phase</th>
                                <th>Sniper</th>
                                <th>Vol Accel</th>
                                <th>B/S Ratio</th>
                                <th>Wallet Gr%</th>
                                <th>Retention%</th>
                                <th>Top10 Œî</th>
                                <th>Drawdown</th>
                                <th>Liq Stab</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rankings-body"></tbody>
                    </table>
                    <div id="loading-msg" style="text-align: center; color: var(--text-dim); padding: 2rem;">Loading
                        phase intelligence...</div>
                </div>
            </div>

            <!-- TAB: Sniper Mode -->
            <div id="sniper-tab" class="tab-panel">
                <div style="padding:1rem 0; color:var(--text-dim); font-size:0.85rem;">Auto-filtered: Score &gt; 75, Liq
                    Stability &gt; 0.7, Early Retention &gt; 60%</div>
                <div class="table-wrapper" style="overflow-x:auto;">
                    <table style="min-width:800px;">
                        <thead>
                            <tr>
                                <th>Token</th>
                                <th>Score</th>
                                <th>Liquidity Stab</th>
                                <th>Vol Accel</th>
                                <th>B/S Ratio</th>
                                <th>Time Since Detection</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sniper-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: Completed Tokens -->
            <div id="completed-tab" class="tab-panel">
                <div style="padding:1rem 0; color:var(--text-dim); font-size:0.85rem;">Tokens with lifecycle: SUCCESS,
                    FAILED, or EXPIRED</div>
                <div class="table-wrapper" style="overflow-x:auto;">
                    <table style="min-width:800px;">
                        <thead>
                            <tr>
                                <th>Token</th>
                                <th>Outcome</th>
                                <th>Score at Detection</th>
                                <th>Risk</th>
                                <th>Lifecycle State</th>
                                <th>Detected</th>
                            </tr>
                        </thead>
                        <tbody id="completed-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 2: Structural Discovery -->
            <div id="discovery-tab" class="tab-panel">
                <div style="color: var(--text-dim); font-size: 0.8rem; padding: 0.5rem 0;">
                    All tokens discovered via firehose. Tokens graduate to Ranked when they sustain liquidity threshold.
                </div>
                <div class="table-wrapper" style="overflow-x:auto;">
                    <table style="min-width:900px;">
                        <thead>
                            <tr>
                                <th>Token</th>
                                <th>Stage</th>
                                <th>Eligibility</th>
                                <th>Age</th>
                                <th>Trades</th>
                                <th>Volume (SOL)</th>
                                <th>Unique Wallets</th>
                                <th>Last Activity</th>
                            </tr>
                        </thead>
                        <tbody id="discovery-body">
                            <tr>
                                <td colspan="7" style="color:var(--text-dim)">Switch to tab to load...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 3: Operations -->
            <div id="ops-tab" class="tab-panel">
                <div class="table-wrapper" style="padding: 1.5rem;">
                    <!-- System Health -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem 0; color: var(--accent);">‚ö° System Health</h3>
                        <div id="health-panel"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                            <div
                                style="background: var(--card); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">
                                    Database</div>
                                <div id="health-db" style="font-size: 1.2rem; font-weight: 700; margin-top: 0.3rem;">‚Äî
                                </div>
                            </div>
                            <div
                                style="background: var(--card); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">Last
                                    Event Age</div>
                                <div id="health-freshness"
                                    style="font-size: 1.2rem; font-weight: 700; margin-top: 0.3rem;">‚Äî</div>
                            </div>
                            <div
                                style="background: var(--card); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">
                                    Ignore Ratio (24h)</div>
                                <div id="health-ignore"
                                    style="font-size: 1.2rem; font-weight: 700; margin-top: 0.3rem;">‚Äî</div>
                            </div>
                            <div
                                style="background: var(--card); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;">
                                    Events (24h)</div>
                                <div id="health-events"
                                    style="font-size: 1.2rem; font-weight: 700; margin-top: 0.3rem;">‚Äî</div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem 0; color: var(--accent);">üîß Actions</h3>
                        <button id="refresh-all-btn" onclick="refreshAllPhases()"
                            style="background: var(--accent); color: #0f172a; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 700; cursor: pointer; margin-right: 1rem;">
                            Refresh All Phases ‚ö°
                        </button>
                        <button id="refresh-prices-btn" onclick="refreshPrices()"
                            style="background: var(--green); color: #0f172a; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 700; cursor: pointer; margin-right: 1rem;">
                            Refresh Prices üí∞
                        </button>
                        <span id="refresh-msg" style="font-size: 0.85rem; color: var(--text-dim);"></span>
                    </div>

                    <!-- Ingestion Stats -->
                    <div>
                        <h3 style="margin: 0 0 1rem 0; color: var(--accent);">üìä Ingestion Stats (Last 10)</h3>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Events</th>
                                    <th>Inserted</th>
                                    <th>Ignored</th>
                                    <th>Exceptions</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="ingestion-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let selectedMint = null;

        async function init() {
            loadRankings();
            setInterval(loadRankings, 30000);
        }

        async function loadRankings() {
            try {
                // ‚úÖ SNAPSHOT-DRIVEN: Fetch from feature_snapshots (not trades)
                const res = await fetch(`${API_BASE}/analytics/snapshots?only_eligible=true&limit=200`);
                const data = await res.json();

                // Transform v2 snapshot data to match expected format
                window._allTokens = data.tokens.map(t => ({
                    // Token identity
                    mint: t.address,
                    token_id: t.token_id,
                    symbol: t.symbol || `${t.address.slice(0, 4)}...${t.address.slice(-4)}`,

                    // Scoring (from snapshot, NOT computed live)
                    ev_score: t.score_total || 0,

                    // Lifecycle
                    lifecycle_stage: t.outcome || 'ACTIVE',
                    phase: t.lifecycle_state || 'unknown',

                    // Features (from snapshot)
                    volume_acceleration: t.volume_acceleration,
                    buy_sell_ratio: t.buy_sell_ratio_1h,
                    unique_wallet_growth: t.unique_wallets_growth,
                    holder_concentration: t.holder_concentration,
                    holder_retention: t.holder_retention,
                    price_volatility: t.price_volatility_1h,
                    price_drawdown: t.price_drawdown_6h,

                    // Dataset Integrity (NEW)
                    snapshot_id: t.snapshot_id,
                    feature_version: t.feature_version,
                    snapshot_time: t.snapshot_time,
                    snapshot_locked: t.snapshot_locked,
                    schema_version: t.dataset_integrity?.schema_version || 2,
                    v2_trade_count: t.dataset_integrity?.v2_trade_count || 0,

                    // Timestamps
                    detected_at: t.detected_at,
                    labeled_at: t.labeled_at,

                    // Eligibility
                    eligibility_status: t.eligibility_status,
                    primary_pair_address: t.primary_pair_address
                }));

                console.log(`‚úÖ Loaded ${data.tokens.length} snapshot-driven tokens (v2)`);
                document.getElementById("loading-msg").style.display = "none";
                applyFilters();
            } catch (err) {
                console.error("Rankings load error:", err);
                document.getElementById("loading-msg").textContent = "Error loading data.";
            }
        }

        const COMPLETED_STAGES = ['SUCCESS', 'FAILED', 'EXPIRED'];

        window.applyFilters = () => {
            let data = window._allTokens || [];
            const minScore = parseFloat(document.getElementById('f-min-score').value) || 0;
            const lifecycle = document.getElementById('f-lifecycle').value;
            const status = document.getElementById('f-status').value;
            const sortKey = document.getElementById('f-sort').value;

            // Filter
            data = data.filter(t => {
                if (t.ev_score < minScore) return false;
                if (lifecycle && t.lifecycle_stage !== lifecycle) return false;
                if (status === 'active' && COMPLETED_STAGES.includes(t.lifecycle_stage)) return false;
                if (status === 'completed' && !COMPLETED_STAGES.includes(t.lifecycle_stage)) return false;
                return true;
            });

            // Sort
            data.sort((a, b) => (b[sortKey] || 0) - (a[sortKey] || 0));

            document.getElementById('filter-count').textContent = `${data.length} token(s)`;
            renderRankedTable(data);
            renderSniperView(window._allTokens || []);
            renderCompletedView(window._allTokens || []);
            // Auto-select first token if none selected
            if (!selectedMint && data.length > 0) selectToken(data[0]);
        };

        function copyMint(mint) {
            navigator.clipboard.writeText(mint);
            // brief visual feedback
            event.target.textContent = '‚úì';
            setTimeout(() => { event.target.textContent = 'üìã'; }, 800);
        }

        function formatPrice(p) {
            if (!p || p === 0) return '‚Äî';
            if (p >= 1) return '$' + p.toFixed(2);
            if (p >= 0.01) return '$' + p.toFixed(4);
            if (p >= 0.0001) return '$' + p.toFixed(6);
            return '$' + p.toExponential(2);
        }

        function timeSince(ts) {
            if (!ts) return '‚Äî';
            const s = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
            if (s < 60) return s + 's';
            if (s < 3600) return Math.floor(s / 60) + 'm';
            if (s < 86400) return Math.floor(s / 3600) + 'h';
            return Math.floor(s / 86400) + 'd';
        }

        function renderRankedTable(data) {
            const tbody = document.getElementById('rankings-body');
            tbody.innerHTML = '';
            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="16" style="text-align:center;">No tokens match filters.</td></tr>`;
                return;
            }
            data.forEach(t => {
                const row = document.createElement('tr');
                if (t.mint === selectedMint) row.classList.add('selected');
                row.onclick = () => selectToken(t);
                const evColor = getEvColor(t.ev_score);
                const phaseClass = getPhaseClass(t.phase);
                const sniperBadge = t.is_sniper_candidate ? '<span style="background:#a855f7; color:white; padding:1px 5px; border-radius:3px; font-size:0.65rem; font-weight:700;">üéØ</span>' : '<span class="dim">‚Äî</span>';
                const fragile = (t.lifecycle_stage === 'FAILED' || t.phase === 'UNSTABLE' || t.phase === 'FRAGILE') ? '<span style="color:var(--red); font-size:0.65rem;"> ‚ö†</span>' : '';
                row.innerHTML = `
                    <td>
                        <div style="font-weight:700;">${t.name || 'Unknown'}</div>
                        <div class="mono dim" style="font-size:0.65rem;">${t.mint.slice(0, 6)}...
                            <span onclick="event.stopPropagation(); copyMint('${t.mint}')" style="cursor:pointer;" title="Copy address">üìã</span>
                        </div>
                    </td>
                    <td class="mono" style="font-size:0.8rem;">${t.current_price > 0 ? formatPrice(t.current_price) : '<span class="dim">‚Äî</span>'}</td>
                    <td class="mono" style="font-size:0.8rem; font-weight:700; color:${t.multiplier ? (t.multiplier >= 2 ? 'var(--green)' : t.multiplier < 1 ? 'var(--red)' : 'var(--text-main)') : 'var(--text-dim)'}">${t.multiplier ? (t.multiplier || 0).toFixed(2) + 'x' : '‚Äî'}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:0.4rem;">
                            <span class="mono" style="color:${evColor}; font-weight:700;">${(t.ev_score || 0).toFixed(1)}</span>
                            <div style="width:30px; height:4px; background:#334155; border-radius:2px;"><div style="width:${t.ev_score || 0}%; height:100%; background:${evColor}; border-radius:2px;"></div></div>
                        </div>
                    </td>
                    <td class="mono" style="font-size:0.8rem; color:${t.risk_penalty > 5 ? 'var(--red)' : 'var(--text-dim)'}">${(t.risk_penalty || 0).toFixed(1)}</td>
                    <td class="mono" style="font-size:0.8rem;">${(t.wallet_score || 0).toFixed(1)}</td>
                    <td><span class="badge ${phaseClass}">${formatPhase(t.phase)}</span>${fragile}</td>
                    <td>${sniperBadge}</td>
                    <td class="mono" style="font-size:0.8rem; color:${t.volume_acceleration > 1.5 ? 'var(--green)' : 'var(--text-dim)'}">${(t.volume_acceleration || 0).toFixed(2)}</td>
                    <td class="mono" style="font-size:0.8rem; color:${t.buy_sell_ratio >= 1.0 ? 'var(--green)' : t.buy_sell_ratio < 0.8 ? 'var(--red)' : 'var(--text-dim)'}">${(t.buy_sell_ratio || 0).toFixed(2)}</td>
                    <td class="mono" style="font-size:0.8rem; color:${t.unique_wallet_growth > 0.2 ? 'var(--green)' : 'var(--text-dim)'}">${((t.unique_wallet_growth || 0) * 100).toFixed(1)}%</td>
                    <td class="mono" style="font-size:0.8rem; color:${t.early_wallet_retention > 0.6 ? 'var(--green)' : t.early_wallet_retention < 0.3 ? 'var(--red)' : 'var(--text-dim)'}">${((t.early_wallet_retention || 0) * 100).toFixed(1)}%</td>
                    <td class="mono" style="font-size:0.8rem; color:${t.top10_concentration_delta > 0.05 ? 'var(--red)' : 'var(--text-dim)'}">${((t.top10_concentration_delta || 0) * 100).toFixed(1)}%</td>
                    <td class="mono" style="font-size:0.8rem; color:${t.drawdown_depth > 0.15 ? 'var(--red)' : 'var(--text-dim)'}">${((t.drawdown_depth || 0) * 100).toFixed(1)}%</td>
                    <td class="mono" style="font-size:0.8rem; color:${t.liquidity_stability > 0.7 ? 'var(--green)' : t.liquidity_stability < 0.4 ? 'var(--red)' : 'var(--text-dim)'}">${(t.liquidity_stability || 0).toFixed(2)}</td>
                    <td>
                        <a href="details.html?token_id=${t.token_id}" class="decision-badge" style="text-decoration:none; background:var(--card-hover); color:var(--accent); border-color:var(--accent); font-size:0.7rem;">DETAIL ‚Üó</a>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSniperView(allData) {
            const filtered = allData.filter(t =>
                t.ev_score > 75 && t.liquidity_stability > 0.7 && t.early_wallet_retention > 0.6
            );
            const tbody = document.getElementById('sniper-body');
            tbody.innerHTML = '';
            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-dim);">No sniper candidates currently.</td></tr>';
                return;
            }
            filtered.forEach(t => {
                const row = document.createElement('tr');
                row.style.background = 'rgba(168,85,247,0.05)';
                row.innerHTML = `
                    <td style="font-weight:700;">${t.name || 'Unknown'}<div class="mono dim" style="font-size:0.65rem;">${t.mint.slice(0, 6)}...</div></td>
                    <td class="mono" style="color:#a855f7; font-weight:700;">${(t.ev_score || 0).toFixed(1)}</td>
                    <td class="mono" style="color:var(--green);">${(t.liquidity_stability || 0).toFixed(2)}</td>
                    <td class="mono">${(t.volume_acceleration || 0).toFixed(2)}</td>
                    <td class="mono">${(t.buy_sell_ratio || 0).toFixed(2)}</td>
                    <td class="mono">${timeSince(t.snapshot_time)}</td>
                    <td><a href="details.html?token_id=${t.token_id}" class="decision-badge" style="text-decoration:none; background:var(--card-hover); color:var(--accent); border-color:var(--accent); font-size:0.7rem;">DETAIL ‚Üó</a></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderCompletedView(allData) {
            const filtered = allData.filter(t => COMPLETED_STAGES.includes(t.lifecycle_stage));
            const tbody = document.getElementById('completed-body');
            tbody.innerHTML = '';
            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-dim);">No completed tokens yet.</td></tr>';
                return;
            }
            filtered.forEach(t => {
                const row = document.createElement('tr');
                const outcomeText = t.outcome ? t.outcome.replace(/_/g, ' ').toUpperCase() : t.lifecycle_stage;
                const outcomeColor = (t.outcome === 'hit_5x' || t.lifecycle_stage === 'SUCCESS') ? 'var(--green)' :
                    (t.lifecycle_stage === 'FAILED' || t.outcome?.includes('failure') || t.outcome?.includes('collapse') || t.outcome?.includes('exit')) ? 'var(--red)' : 'var(--yellow)';

                row.innerHTML = `
                    <td style="font-weight:700;">${t.name || 'Unknown'}<div class="mono dim" style="font-size:0.65rem;">${t.mint.slice(0, 6)}...</div></td>
                    <td style="color:${outcomeColor}; font-weight:700;">${outcomeText}</td>
                    <td class="mono">${(t.ev_score || 0).toFixed(1)}</td>
                    <td class="mono" style="color:${t.risk_penalty > 5 ? 'var(--red)' : 'var(--text-dim)'}">${(t.risk_penalty || 0).toFixed(1)}</td>
                    <td><span class="badge ${getPhaseClass(t.phase)}">${formatPhase(t.phase)}</span></td>
                    <td class="mono dim" style="font-size:0.8rem;">${t.snapshot_time ? new Date(t.snapshot_time).toLocaleDateString() : '‚Äî'}</td>
                `;
                tbody.appendChild(row);
            });
        }



        function selectToken(t) {
            selectedMint = t.mint;
            document.getElementById("selected-mint").value = t.mint;
            document.querySelectorAll("#rankings-body tr").forEach(r => r.classList.remove("selected"));

            // Header
            document.getElementById("detail-name").textContent = t.symbol || "Unknown";
            document.getElementById("detail-mint").textContent = t.address;
            document.getElementById("detail-dex-link").href = `https://dexscreener.com/solana/${t.address}`;

            // Phase Block
            const badge = document.getElementById("detail-phase-badge");
            badge.className = `main-phase-badge ${getPhaseClass(t.lifecycle_state)}`;
            badge.textContent = formatPhase(t.lifecycle_state);

            const evEl = document.getElementById("detail-ev");
            const score = t.ev_score || 0;
            evEl.textContent = (score || 0).toFixed(1);
            evEl.style.color = getEvColor(score);

            const biasEl = document.getElementById("detail-bias");
            // Decision logic basic mapping
            let decision = "WAIT";
            if (score > 80) decision = "BUY";
            else if (score > 60) decision = "WATCH";
            else if (score < 20) decision = "AVOID";

            biasEl.textContent = decision;
            biasEl.className = `decision-badge decision-${decision}`;

            const asymEl = document.getElementById("detail-asymmetry");
            if (score >= 80) asymEl.textContent = "High Expected Value";
            else if (score >= 65) asymEl.textContent = "Strong Opportunity";
            else if (score >= 50) asymEl.textContent = "Moderate";
            else if (score >= 35) asymEl.textContent = "Weak Signal";
            else asymEl.textContent = "Avoid";
            asymEl.style.color = getEvColor(score);

            // EV Components - V2 Snapshots don't have breakdown in list view.
            // We show placeholders or map proxies.
            setVal("sig-structural", t.volume_acceleration, 2); // Proxy Momentum
            document.querySelector("#sig-structural").previousElementSibling.textContent = "Vol Accel (Mom)";

            setVal("sig-capital", t.liquidity_stability, 2); // Proxy Market Quality
            document.querySelector("#sig-capital").previousElementSibling.textContent = "Liq Stability";

            setVal("sig-lifecycle", t.buy_sell_ratio, 2); // Proxy Participation
            document.querySelector("#sig-lifecycle").previousElementSibling.textContent = "Buy/Sell Ratio";

            setVal("sig-wallet", t.wallet_score, 2); // Holder Concentration/Retention
            document.querySelector("#sig-wallet").previousElementSibling.textContent = "Holder Conc.";

            // Participation
            setVal("sig-uniques", 0); // Not in snapshot list
            setVal("sig-ratio", t.buy_sell_ratio, 2); // Reuse
            setVal("sig-vpu", 0, 2, "$"); // Not available
            setVal("sig-cv", t.price_volatility, 2); // Price Volatility

            // USR interpretation
            document.getElementById("int-ratio").textContent = "";

            // Growth & Risk
            setDelta("sig-ugr", t.unique_growth); // unique_wallets_growth
            setDelta("sig-vgr", t.volume_growth); // volume_growth_rate_1h
            setVal("sig-decline", t.price_drawdown, 2, "", "%"); // price_drawdown_6h
            setVal("sig-dsp", t.age_hours, 1, "", "h"); // Age
            document.querySelector("#sig-dsp").previousElementSibling.textContent = "Age (Hours)";

            // Time in phase
            document.getElementById("detail-time").textContent = `${(t.age_hours || 0).toFixed(1)}h`;
        }

        // Helpers
        function getPhaseClass(p) {
            const map = {
                'INITIAL': 'bg-early',
                'ACCELERATION': 'bg-xp',
                'EARLY_EXPANSION': 'bg-xp',
                'EXPANSION': 'bg-xp',
                'MATURE': 'bg-accum',
                'DISTRIBUTION': 'bg-hype',
                'DESTRUCTIVE': 'bg-dest',
                'POST_DESTRUCTIVE': 'bg-post',
                'DORMANT': 'bg-unk',
            };
            return map[p] || 'bg-unk';
        }
        function formatPhase(p) { return p ? p.replaceAll('_', ' ') : "UNKNOWN"; }
        function getEvColor(s) { return s >= 65 ? "var(--green)" : s >= 35 ? "var(--yellow)" : "var(--red)"; }

        function setVal(id, v, dec = 0, pre = "", suf = "") {
            const el = document.getElementById(id);
            if (v === undefined || v === null) el.textContent = "‚Äî";
            else el.textContent = pre + v.toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec }) + suf;
        }
        function setDelta(id, v) {
            const el = document.getElementById(id);
            if (v === undefined || v === null) { el.textContent = "‚Äî"; el.style.color = "var(--text-dim)"; return; }
            const arrow = v > 0 ? "‚Üë" : v < 0 ? "‚Üì" : "";
            el.textContent = `${arrow} ${(v * 100).toFixed(1)}%`;
            el.style.color = v > 0.1 ? "var(--green)" : v < -0.1 ? "var(--red)" : "var(--text-dim)";
        }

        // Tabs
        window.switchTab = (id) => {
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
            document.querySelector(`.tab[data-tab="${id}"]`).classList.add("active");
            document.getElementById(id).classList.add("active");
            // Load data when switching tabs
            if (id === 'ops-tab') { loadHealth(); loadIngestionStats(); }
            if (id === 'discovery-tab') { loadDiscovery(); }
        };

        // Discovery ‚Äî lightweight local view
        async function loadDiscovery() {
            const tbody = document.getElementById("discovery-body");
            tbody.innerHTML = "<tr><td colspan='7' style='color:var(--text-dim)'>Loading...</td></tr>";
            try {
                const res = await fetch(`${API_BASE}/analytics/discovery`);
                const data = await res.json();
                tbody.innerHTML = "";
                if (!data.length) {
                    tbody.innerHTML = "<tr><td colspan='7' style='color:var(--text-dim)'>No tokens discovered yet.</td></tr>";
                    return;
                }
                data.forEach(t => {
                    const row = document.createElement("tr");
                    const stageColors = {
                        'PRE_ELIGIBLE': 'var(--text-dim)',
                        'ACTIVE_MONITORING': 'var(--accent)',
                        'SUCCESS': 'var(--green)',
                        'FAILED': 'var(--red)',
                    };
                    const stageCol = stageColors[t.stage] || 'var(--text-dim)';

                    const eligColors = {
                        'PRE_ELIGIBLE': 'var(--text-dim)',
                        'ELIGIBLE_PENDING_30M': 'var(--accent)',
                        'ELIGIBLE': 'var(--green)',
                        'REJECTED': 'var(--red)'
                    };
                    const eligCol = eligColors[t.eligibility_status] || 'var(--text-dim)';

                    const volStr = t.volume_sol > 0 ? t.volume_sol.toFixed(1) : '‚Äî';
                    const lastAct = t.last_trade ? new Date(t.last_trade).toLocaleString() : '‚Äî';
                    row.innerHTML = `
                        <td>
                            <div style="font-weight:600;">${t.symbol || t.name}</div>
                            <div class="mono" style="font-size:0.65rem; color:var(--text-dim); cursor:pointer;" onclick="navigator.clipboard.writeText('${t.address}')" title="Click to copy">${t.address.slice(0, 6)}...${t.address.slice(-4)}</div>
                        </td>
                        <td style="color:${stageCol}; font-size:0.75rem; font-weight:600;">${t.stage}</td>
                        <td style="color:${eligCol}; font-size:0.75rem; font-weight:600;">${t.eligibility_status}</td>
                        <td class="mono" style="font-size:0.8rem;">${t.age || '‚Äî'}</td>
                        <td class="mono" style="font-size:0.8rem;">${t.trade_count.toLocaleString()}</td>
                        <td class="mono" style="font-size:0.8rem;">${volStr}</td>
                        <td class="mono" style="font-size:0.8rem;">${t.unique_wallets}</td>
                        <td style="font-size:0.7rem; color:var(--text-dim);">${lastAct}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                tbody.innerHTML = "<tr><td colspan='7' style='color:var(--red)'>Error loading discovery data.</td></tr>";
                console.error("Discovery error:", e);
            }
        }

        // Alert
        window.createAlert = async (e) => {
            e.preventDefault();
            const mint = document.getElementById("selected-mint").value;
            const val = document.getElementById("alert-val").value;
            if (!mint || !val) return;
            try {
                await fetch(`${API_BASE}/alerts/`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token_mint: mint, metric: "swap_count_1h", condition: "gt", value: parseFloat(val), cooldown_minutes: 60 })
                });
                document.getElementById("alert-msg").textContent = "Alert set!";
                document.getElementById("alert-msg").style.color = "var(--green)";
                loadAlerts(); // refresh list
            } catch (e) { document.getElementById("alert-msg").textContent = "Error"; }
        };

        // List Active Alerts
        async function loadAlerts() {
            try {
                const res = await fetch(`${API_BASE}/alerts/`);
                const data = await res.json();
                const el = document.getElementById('alerts-list');
                if (!data.length) { el.textContent = 'No active alerts'; return; }
                el.innerHTML = data.map(a => `
                    <div style="padding:0.4rem 0; border-bottom:1px solid rgba(51,65,85,0.3); display:flex; justify-content:space-between;">
                        <span>${a.metric} ${a.condition} ${a.value}</span>
                        <span class="dim">${a.token_mint.slice(0, 4)}...</span>
                    </div>
                `).join('');
            } catch (e) { document.getElementById('alerts-list').textContent = 'Error loading'; }
        }

        // Phase Transition Check
        window.checkPhaseTransitions = async () => {
            const el = document.getElementById('phase-check-msg');
            el.textContent = 'Checking...';
            el.style.color = 'var(--text-dim)';
            try {
                const res = await fetch(`${API_BASE}/alerts/check`, { method: 'POST' });
                const data = await res.json();
                if (data.alerts_sent > 0) {
                    el.textContent = `üöÄ ${data.alerts_sent} transition(s) found!`;
                    el.style.color = 'var(--green)';
                } else {
                    el.textContent = 'No transitions detected.';
                    el.style.color = 'var(--text-dim)';
                }
            } catch (e) { el.textContent = 'Error'; el.style.color = 'var(--red)'; }
        };

        // System Health
        async function loadHealth() {
            try {
                const res = await fetch(`${API_BASE}/analytics/health`);
                const d = await res.json();
                document.getElementById('health-db').textContent = d.status === 'ok' ? '‚úÖ Connected' : '‚ùå Error';
                document.getElementById('health-db').style.color = d.status === 'ok' ? 'var(--green)' : 'var(--red)';
                const age = d.last_insert_age_seconds;
                document.getElementById('health-freshness').textContent = age != null ? (age < 60 ? `${age}s` : age < 3600 ? `${Math.round(age / 60)}m` : `${Math.round(age / 3600)}h`) : 'N/A';
                document.getElementById('health-freshness').style.color = age != null && age < 300 ? 'var(--green)' : 'var(--yellow)';
                document.getElementById('health-ignore').textContent = (d.ignore_ratio_24h * 100).toFixed(1) + '%';
                document.getElementById('health-ignore').style.color = d.ignore_ratio_24h < 0.1 ? 'var(--green)' : 'var(--red)';
                document.getElementById('health-events').textContent = (d.total_events_24h || 0).toLocaleString();
            } catch (e) { console.error('Health load error:', e); }
        }

        // Ingestion Stats
        async function loadIngestionStats() {
            try {
                const res = await fetch(`${API_BASE}/metrics/ingestion-stats`);
                const data = await res.json();
                const tbody = document.getElementById('ingestion-body');
                tbody.innerHTML = '';
                data.forEach(s => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${s.source}</td>
                        <td class="mono">${s.events_received}</td>
                        <td class="mono green">${s.swaps_inserted}</td>
                        <td class="mono yellow">${s.swaps_ignored}</td>
                        <td class="mono red">${s.details.exceptions}</td>
                        <td class="dim" style="font-size:0.75rem;">${new Date(s.timestamp).toLocaleTimeString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) { console.error('Ingestion stats error:', e); }
        }

        // Refresh All Phases
        window.refreshAllPhases = async () => {
            const btn = document.getElementById('refresh-all-btn');
            const msg = document.getElementById('refresh-msg');
            btn.disabled = true; btn.textContent = 'Refreshing...';
            msg.textContent = '';
            try {
                const res = await fetch(`${API_BASE}/analytics/refresh`, { method: 'POST' });
                const data = await res.json();
                msg.textContent = `‚úÖ ${data.tokens_analyzed} tokens re-analyzed`;
                msg.style.color = 'var(--green)';
                loadRankings(); // refresh main table
            } catch (e) {
                msg.textContent = '‚ùå Failed'; msg.style.color = 'var(--red)';
            } finally {
                btn.disabled = false; btn.textContent = 'Refresh All Phases ‚ö°';
            }
        };

        window.refreshPrices = async () => {
            const btn = document.getElementById('refresh-prices-btn');
            const msg = document.getElementById('refresh-msg');
            btn.disabled = true; btn.textContent = 'Fetching prices...';
            msg.textContent = '';
            try {
                const res = await fetch(`${API_BASE}/prices/refresh`);
                const data = await res.json();
                if (data.status === 'ok') {
                    msg.textContent = `üí∞ ${data.updated} token prices updated`;
                    msg.style.color = 'var(--green)';
                    loadRankings(); // refresh table with new prices
                } else {
                    msg.textContent = `‚ö†Ô∏è ${data.error || 'Unknown error'}`;
                    msg.style.color = 'var(--yellow)';
                }
            } catch (e) {
                msg.textContent = '‚ùå Price refresh failed'; msg.style.color = 'var(--red)';
            } finally {
                btn.disabled = false; btn.textContent = 'Refresh Prices üí∞';
            }
        };

        init();
        loadAlerts(); // load on startup
    </script>
</body>

</html>